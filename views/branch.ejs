<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./dashboard/head') %>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
  <div class="wrapper">
    <!-- Sidebar -->
    <%- include('./dashboard/sidebar') %>
    <!-- End Sidebar -->

    <div class="main-panel">
      <%- include('./dashboard/header') %>

      <div class="container">
        <div class="page-inner">
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Manage Branch Services</div>
                </div>
                <div class="card-body">
                  <form action="/branches/manage" method="POST">
                    <div class="row">
                      <div class="col-md-12 col-lg-12">
                        <div class="form-floating form-floating-custom mb-3">
                          <select
                            class="form-select"
                            id="branchSelect"
                            name="branchId"
                            required
                          >
                            <option value="" disabled selected>Select Branch</option>
                            <% branches.forEach(branch => { %>
                              <option value="<%= branch.id %>"><%= branch.name %></option>
                            <% }) %>
                          </select>
                          <label for="branchSelect">Branch</label>
                        </div>
                        <div class="form-floating form-floating-custom mb-3">
                          <select
                            class="form-select"
                            id="serviceSelect"
                            name="services"
                            multiple="multiple"
                            required
                          >
                          </select>
                          <label for="serviceSelect">Select Services</label>
                        </div>
                      </div>
                    </div>
                    <div class="card-action">
                      <button class="btn btn-success" type="submit">Add Services</button>
                      <button class="btn btn-danger" id="removeServiceBtn" type="button">Remove Selected Services</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Existing Services in Branch</div>
                </div>
                <div class="card-body">
                  <ul id="existingServicesList" class="list-group">
                  </ul>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0/js/select2.min.js" defer></script>
  <%- include('./dashboard/foot') %>
  
  <script>
    $(document).ready(function() {
      // Initialize Select2 on the select elements
      $('#branchSelect').select2({
        placeholder: "Select Branch"
      });

      $('#serviceSelect').select2({
        placeholder: "Select Services"
      });

      

      $('#branchSelect').on('change', function() {
        console.log("test")
        const branchId = $(this).val();
        console.log("test");
        console.log('Branch selected:', $(this).val());

        // Fetch available services
        fetch(`/branches/${branchId}/services`)
          .then(response => response.json())
          .then(data => {
            $('#existingServicesList').empty();
            data.forEach(service => {
              $('#existingServicesList').append(`<li class="list-group-item">${service.nameService}</li>`);
            });
          })
          .catch(error => {
            console.error('Error fetching branch services:', error);
          });

        // Fetch all services and populate the Select2 dropdown
        fetch(`/services/all`)
        console.log('Data services:', data)// test fetch
          .then(response => response.json())
          .then(data => {
            $('#serviceSelect').empty();
            data.forEach(service => {
              const option = new Option(service.nameService, service.id, false, false);
              $('#serviceSelect').append(option);
            });

            // Trigger Select2 to update the UI
            $('#serviceSelect').trigger('change');
          })
          .catch(error => {
            console.error('Error fetching services:', error);
          });
      });

      $('#removeServiceBtn').on('click', function() {
        console.log("test")
        const branchId = $('#branchSelect').val();
        const selectedServices = $('#serviceSelect').val();

        if (!branchId || !selectedServices.length) {
          alert('Please select a branch and at least one service to remove.');
          return;
        }

        $.ajax({
          url: `/branches/${branchId}/remove-services`,
          method: 'POST',
          data: { services: selectedServices },
          success: function(response) {
            alert('Services removed successfully.');
            // Refresh existing services list
            $('#branchSelect').trigger('change');
          },
          error: function(error) {
            console.error('Error removing services:', error);
            alert('Failed to remove services.');
          }
        });
      });
    });
  </script>
</body>
</html>
